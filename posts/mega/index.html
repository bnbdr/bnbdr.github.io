<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content=True><meta name=MobileOptimized content=320><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content=no-referrer><meta name=author content=bnbdr><meta name=description content="waiting for a fix is human; patching it yourself, divine"><meta property=og:site_name content=https://bnbdr.github.io/><meta property=og:type content=object><meta property=og:image content=https://bnbdr.github.io/posts/mega/previcon.png><meta property=og:title content="Making Explorer.exe Great Again"><meta property=og:url content=https://bnbdr.github.io/posts/mega/><meta property=og:description content="waiting for a fix is human; patching it yourself, divine"><title>Making Explorer.exe Great Again</title><link rel=canonical href=https://bnbdr.github.io/posts/mega/><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500"><link rel=stylesheet href=https://bnbdr.github.io/css/reset.min.css><link rel=stylesheet href=https://bnbdr.github.io/css/pygments.min.css><link rel=stylesheet href=https://bnbdr.github.io/css/main.min.css><link rel="shortcut icon" href=https://bnbdr.github.io/img/icon.png></head><body lang=en><section class=header><div class=container><div class=content><div class=author_name>bnbdr</div><div class=profpic_container><a href=https://bnbdr.github.io/ class=profpic_anchor><img id=profpic src=https://bnbdr.github.io/img/avatar.png></a></div><div class=icons_wrapper><a href=//github.com/bnbdr target=_blank rel=noopener><div class=backicon id=githubicon></div></a><a href=//twitter.com/bnbdr target=_blank rel=noopener><div class=backicon id=twittericon></div></a></div></div></div></section><section class=main><div class=container><div class=content><div class=page-heading>Making Explorer.exe Great Again<br><div class=sub-title>waiting for a fix is human; patching it yourself, divine</div></div><div class=inpost-date>Sep 9, 2018</div><ul id=tags-single><li class=posttag><a class=tag href=https://bnbdr.github.io/tags/windows>#windows</a></li><li class=posttag><a class=tag href=https://bnbdr.github.io/tags/reversing>#reversing</a></li></ul><div class=markdown><p>The horrid amalgamation of code known as <code>Windows Vista</code> wasn&rsquo;t <em>all</em> bad. As a result of the many <a href=https://xkcd.com/326/>effected</a> changes, users were given the ability to run an executable by typing its name in the navigation bar of <code>explorer.exe</code>&rsquo;s window<sup class=footnote-ref id=fnref:1><a href=#fn:1>1</a></sup>. By doing so the newly created process had its <code>working directory</code> set to the one shown in that window.</p><p>Sadly, even this one redeeming feature has an unfortunate side effect: <strong>subsequent attempts to select the path of the directory from the nav bar will yield something else - the absolute path of the executable that was run</strong>.</p><p><img src=example.gif alt></p><h3 id=let-the-hate-flow-through-you>Let the hate flow through you</h3><p>After ~7 years of coping with this issue I eventually snapped. Fueled by anger due to my most recent path-related mishap I decided this merits a &ldquo;proper&rdquo; fix instead of always navigating <em><strong>one-dir-up-and-then-back</strong></em> â„¢ to revert the path to its correct value.</p><p>I opened <code>procmon</code> and looked for the culprit. Evidently the blame should fall on <code>ExplorerFrame.dll</code>, within which <code>CAddressEditBox::_NavigateAfterParse</code> calls <code>SetWindowText</code> and thus <del><em>making my life a living hell</em></del> changing the navigation bar text.</p><p><img src=disasm.png alt></p><h3 id=it-s-over-i-have-the-high-ground>It&rsquo;s over, I have the high ground</h3><p>Using <code>windbg</code>, I made it so the code would never reach the <code>SetWindowText</code> call and it seemed to fix it. I went ahead and patched the DLL in <code>system32</code> with a boastful grin, foolishly forgetting Microsoft&rsquo;s chronic new take on updates&hellip;</p><p>The <strong>new</strong> plan was to use the windows Debug API to get the symbol information for both functions and then use <code>Capstone</code> to locate the call to <code>CAddressEditBox::_CanStompCurrentText</code>. This way I could patch it every time my OS (forcibly) updates.</p><p>To prevent the path from changing I simply patch the code to make the path <em>&ldquo;un-stomp-able&rdquo;</em> by making sure the <code>ZF</code> is always set:
<img src=patch.png alt></p><p>I implemented this in <code>Python</code> using <code>ctypes</code> and also wrote a small <code>batch</code> script to make overwriting the original DLL easier.</p><h3 id=a-surprise-to-be-sure-but-a-welcome-one>A surprise, to be sure, but a welcome one</h3><p>To my amazement the patch not only works on my machine, but <strong>on older versions as well</strong><sup class=footnote-ref id=fnref:2><a href=#fn:2>2</a></sup>. The only one that required a slight adjustment was <code>Windows 7 64-bit</code>.</p><p><a href=//github.com/bnbdr/mega/>the code is available here</a> ðŸ˜ˆ.</p><div class=footnotes><hr><ol><li id=fn:1>This was possible in <code>Windows XP</code> but you had to write the absolute path of the executable.
<a class=footnote-return href=#fnref:1>â†‘</a></li><li id=fn:2>see the project&rsquo;s <a href=//github.com/bnbdr/mega/>README.md</a> for more info.
<a class=footnote-return href=#fnref:2>â†‘</a></li></ol></div></div></div></div></section></body></html>